<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Fx2lib: fw.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fx2lib&#160;<span id="projectnumber">0.2</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">fw.c</div>  </div>
</div>
<div class="contents">
<p>The firmware framework allows for easily beginning a new firware project.</p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;<a class="code" href="fx2macros_8h.html">fx2macros.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="fx2ints_8h.html">fx2ints.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="autovector_8h.html">autovector.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="delay_8h.html">delay.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="setupdat_8h.html">setupdat.h</a>&gt;</span>

<span class="preprocessor">#ifdef DEBUG_FIRMWARE </span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="serial_8h.html">serial.h</a>&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#define printf(...)</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>



<span class="keyword">volatile</span> bit dosud=<a name="a0"></a><a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<span class="keyword">volatile</span> bit dosuspend=<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;

<span class="comment">// custom functions</span>
<span class="keyword">extern</span> <span class="keywordtype">void</span> main_loop();
<span class="keyword">extern</span> <span class="keywordtype">void</span> main_init();


<span class="keywordtype">void</span> main() {

<span class="preprocessor">#ifdef DEBUG_FIRMWARE</span>
<span class="preprocessor"></span> <a name="a1"></a><a class="code" href="fx2macros_8h.html#a85439206834e5f5b2b948c6084e18232" title="Sets the cpu to operate at a specific clock speed.">SETCPUFREQ</a>(<a name="a2"></a><a class="code" href="fx2macros_8h.html#a67f3f766a011dd62ac7cae6dfb8b32feaad55ec0a3c2b236a8ef306e941f1f845">CLK_48M</a>); <span class="comment">// required for sio0_init </span>
 <span class="comment">// main_init can still set this to whatever you want.</span>
 <a name="a3"></a><a class="code" href="serial_8h.html#ac43ec735681d3f7efba3babb6a89da7e">sio0_init</a>(57600); <span class="comment">// needed for printf if debug defined </span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
 main_init();

 <span class="comment">// set up interrupts.</span>
 <a name="a4"></a><a class="code" href="autovector_8h.html#a1075368b1aef9ee174d20e697c20f853">USE_USB_INTS</a>();
 
 <a name="a5"></a><a class="code" href="autovector_8h.html#a875914c354c8bb520abd2e3bb7e3a86e">ENABLE_SUDAV</a>();
 <a name="a6"></a><a class="code" href="autovector_8h.html#ad0961fc983212f47b9303b01ae07abdf">ENABLE_USBRESET</a>();
 <a name="a7"></a><a class="code" href="autovector_8h.html#a9da28432c254ba886f731fb95d7ffeda">ENABLE_HISPEED</a>(); 
 <a name="a8"></a><a class="code" href="autovector_8h.html#a23d6df992251bc62695356c41db3d943">ENABLE_SUSPEND</a>();
 <a name="a9"></a><a class="code" href="fx2ints_8h.html#a95df470686ff623c08b75542247f52b1" title="Enable the Resume Interrupt. Requires EA=1 separately.">ENABLE_RESUME</a>();

 <a name="a10"></a><a class="code" href="fx2regs_8h.html#ab14bbb7ca4fbb20994632aeacb983bba">EA</a>=1;

<span class="comment">// iic files (c2 load) don&#39;t need to renumerate/delay</span>
<span class="comment">// trm 3.6</span>
<span class="preprocessor">#ifndef NORENUM</span>
<span class="preprocessor"></span> <a name="a11"></a><a class="code" href="fx2macros_8h.html#a90cc977065675579e3898ff2bbd9093a" title="Cause the device to disconnect and reconnect to the USB bus. This macro doesn&#39;t do anything if the fi...">RENUMERATE</a>();
<span class="preprocessor">#else</span>
<span class="preprocessor"></span> <a name="a12"></a><a class="code" href="fx2regs_8h.html#ac4b149895ad3c0593a35f49aedb3fe40" title="USB Control &amp; Status.">USBCS</a> &amp;= ~<a name="a13"></a><a class="code" href="fx2regs_8h.html#a36e8ad3a10c137c3c6778aae82041a62">bmDISCON</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span> 
 <span class="keywordflow">while</span>(<a name="a14"></a><a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa82764c3079aea4e60c80e45befbb839">TRUE</a>) {

     main_loop();

     <span class="keywordflow">if</span> (dosud) {
       dosud=<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
       <a name="a15"></a><a class="code" href="setupdat_8h.html#ad6bf0b58c902d6fc13d9a0630d95c8a0">handle_setupdata</a>();
     }

     <span class="keywordflow">if</span> (dosuspend) {
        dosuspend=<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
        <span class="keywordflow">do</span> {
           printf ( <span class="stringliteral">&quot;I&#39;m going to Suspend.\n&quot;</span> );
           <a name="a16"></a><a class="code" href="fx2regs_8h.html#a009d91e204071cb1a56b82aaab01ae03" title="Wakeup source and polarity.">WAKEUPCS</a> |= <a name="a17"></a><a class="code" href="fx2regs_8h.html#ace69e6a6ab10c5723b74ba4eb93ccf2f">bmWU</a>|<a name="a18"></a><a class="code" href="fx2regs_8h.html#aab0b110a0756155959fee58a7faddca1">bmWU2</a>; <span class="comment">// make sure ext wakeups are cleared</span>
           <a name="a19"></a><a class="code" href="fx2regs_8h.html#aa0d6d37f56ad3aa26d35021c6833a2d0" title="Put chip into suspend.">SUSPEND</a>=1;
           <a name="a20"></a><a class="code" href="fx2regs_8h.html#a20c344fc5da4bf308bccb637aa47a368">PCON</a> |= 1;
           _asm
           nop
           nop
           nop
           nop
           nop
           nop
           nop
           _endasm;
        } <span class="keywordflow">while</span> ( !<a name="a21"></a>remote_wakeup_allowed &amp;&amp; <a name="a22"></a><a class="code" href="fx2macros_8h.html#a8228b1a75679036ba2b6e59538fbd227" title="Evaluates to TRUE if a remote wakeup event has occurred.">REMOTE_WAKEUP</a>()); 
        printf ( <span class="stringliteral">&quot;I&#39;m going to wake up.\n&quot;</span>);

        <span class="comment">// resume</span>
        <span class="comment">// trm 6.4</span>
        <span class="keywordflow">if</span> ( <a class="code" href="fx2macros_8h.html#a8228b1a75679036ba2b6e59538fbd227" title="Evaluates to TRUE if a remote wakeup event has occurred.">REMOTE_WAKEUP</a>() ) {
            <a name="a23"></a><a class="code" href="delay_8h.html#a483e8dfb2de1a2b29a6c2f806fefe404">delay</a>(5);
            <a class="code" href="fx2regs_8h.html#ac4b149895ad3c0593a35f49aedb3fe40" title="USB Control &amp; Status.">USBCS</a> |= <a name="a24"></a><a class="code" href="fx2regs_8h.html#a54116c48efff8d4df095a3071593b13d">bmSIGRESUME</a>;
            <a class="code" href="delay_8h.html#a483e8dfb2de1a2b29a6c2f806fefe404">delay</a>(15);
            <a class="code" href="fx2regs_8h.html#ac4b149895ad3c0593a35f49aedb3fe40" title="USB Control &amp; Status.">USBCS</a> &amp;= ~<a class="code" href="fx2regs_8h.html#a54116c48efff8d4df095a3071593b13d">bmSIGRESUME</a>;
        }

     }

 } <span class="comment">// end while</span>

} <span class="comment">// end main</span>

<span class="keywordtype">void</span> resume_isr() interrupt <a name="a25"></a><a class="code" href="fx2ints_8h.html#a48b90e65d400542fd0fecf54ab31da1ea72aa08501004f9ba4cc88a3d35835130" title="Resume interrupt.">RESUME_ISR</a> {
 <a name="a26"></a><a class="code" href="fx2ints_8h.html#ac2086c0e85e889d34e6892d2c484a3fd" title="Clear the resume interrupt. Use within the resume interrupt handler.">CLEAR_RESUME</a>();
}
  
<span class="keywordtype">void</span> <a name="a27"></a><a class="code" href="autovector_8h.html#ab83cb52e076952b51d21382f0c721440">sudav_isr</a>() interrupt <a name="a28"></a><a class="code" href="autovector_8h.html#abc626159c878a9a277f47d71a79e7c34a1b501c443ad73d66726f98181f729620">SUDAV_ISR</a> {
 dosud=<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa82764c3079aea4e60c80e45befbb839">TRUE</a>;
 <a name="a29"></a><a class="code" href="autovector_8h.html#a40de022c347065936f788fc320056003">CLEAR_SUDAV</a>();
}
<span class="keywordtype">void</span> <a name="a30"></a><a class="code" href="autovector_8h.html#aa4054efc48f7912ce233ed23fd70103a">usbreset_isr</a>() interrupt <a name="a31"></a><a class="code" href="autovector_8h.html#abc626159c878a9a277f47d71a79e7c34a9bd47dd8ceb10c7f768c7362a5334e07">USBRESET_ISR</a> {
 <a name="a32"></a><a class="code" href="setupdat_8h.html#a873d26420c81b22db52bfc53b214e91a">handle_hispeed</a>(<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
 <a name="a33"></a><a class="code" href="autovector_8h.html#a955ce72b3d57ceb582d1755e4e221401">CLEAR_USBRESET</a>();
}
<span class="keywordtype">void</span> <a name="a34"></a><a class="code" href="autovector_8h.html#a35024ee12369d449ac9e03b9881299f1">hispeed_isr</a>() interrupt <a name="a35"></a><a class="code" href="autovector_8h.html#abc626159c878a9a277f47d71a79e7c34a3674d45bfc937779b77f6494ec203c32">HISPEED_ISR</a> {
 <a class="code" href="setupdat_8h.html#a873d26420c81b22db52bfc53b214e91a">handle_hispeed</a>(<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa82764c3079aea4e60c80e45befbb839">TRUE</a>);
 <a name="a36"></a><a class="code" href="autovector_8h.html#ad0056e85bd6c6a0fdfe2729fe3fc9586">CLEAR_HISPEED</a>();
}

<span class="keywordtype">void</span> <a name="a37"></a><a class="code" href="autovector_8h.html#ac73f26b1052c8ea90c58def9faa10e3f">suspend_isr</a>() interrupt <a name="a38"></a><a class="code" href="autovector_8h.html#abc626159c878a9a277f47d71a79e7c34a7ccd5a6d6c876c4735ac160b2888fe37">SUSPEND_ISR</a> {
 dosuspend=<a class="code" href="fx2types_8h.html#acfa04764efb00fc412359554dd70fff2aa82764c3079aea4e60c80e45befbb839">TRUE</a>;
 <a name="a39"></a><a class="code" href="autovector_8h.html#a4f8b89940af82278db41486b83c55ba3">CLEAR_SUSPEND</a>();
}
</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu May 12 2011 08:21:37 for Fx2lib by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
